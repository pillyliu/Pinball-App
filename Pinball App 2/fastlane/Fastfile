default_platform(:ios)
require "json"

platform :ios do
  private_lane :resolve_ios_simulator_id do |options|
    scheme = options[:scheme] || "Pinball App 2"
    project = options[:project] || "../Pinball App 2.xcodeproj"
    destinations_json = sh(
      "xcodebuild -project '#{project}' -scheme '#{scheme}' -showdestinations -json 2>/dev/null || true"
    ).to_s.strip

    simulator_id = nil
    unless destinations_json.empty?
      begin
        parsed = JSON.parse(destinations_json)
        rows = if parsed.is_a?(Hash)
          (parsed["availableDestinations"] || []) + (parsed["destinations"] || [])
        elsif parsed.is_a?(Array)
          parsed
        else
          []
        end
        simulator_id = rows.find do |row|
          row.is_a?(Hash) &&
            row["platform"] == "iOS Simulator" &&
            row["name"] != "Any iOS Simulator Device" &&
            !(row["id"] || "").include?("placeholder")
        end&.dig("id")
      rescue JSON::ParserError
        simulator_id = nil
      end
    end

    if simulator_id.to_s.empty?
      simulator_id = sh(
        "xcodebuild -project '#{project}' -scheme '#{scheme}' -showdestinations 2>/dev/null | " \
        "awk -F '[,}]' '/platform:iOS Simulator/ && $0 !~ /Any iOS Simulator Device/ " \
        "{for(i=1;i<=NF;i++){if($i ~ /id:/){gsub(/.*id:[ ]*/, \"\", $i);gsub(/ /, \"\", $i); print $i; exit}}}'"
      ).strip
    end

    UI.user_error!("No available iOS simulator destination found") if simulator_id.to_s.empty?
    simulator_id
  end

  private_lane :ensure_asc_env do
    ensure_env_vars(
      env_vars: %w[
        APP_STORE_CONNECT_KEY_ID
        APP_STORE_CONNECT_ISSUER_ID
        APP_STORE_CONNECT_KEY_PATH
      ]
    )
  end

  desc "Run practice migration XCTest suite"
  lane :test do |options|
    scheme = options[:scheme] || "Pinball App 2"
    project = options[:project] || "../Pinball App 2.xcodeproj"
    simulator_id = resolve_ios_simulator_id(project: project, scheme: scheme)
    UI.message("Using simulator id: #{simulator_id}")
    sh(
      "xcodebuild -project '#{project}' -scheme '#{scheme}' -sdk iphonesimulator " \
      "-destination 'platform=iOS Simulator,id=#{simulator_id}' " \
      "-only-testing:'Pinball App 2Tests/PracticeStateCodecTests' test"
    )
  end

  desc "Build an App Store archive"
  lane :build do |options|
    test(options)
    build_app(
      project: options[:project] || "../Pinball App 2.xcodeproj",
      scheme: options[:scheme] || "Pinball App 2",
      clean: true,
      export_method: "app-store"
    )
  end

  desc "Build and upload to TestFlight"
  lane :beta do |options|
    ensure_asc_env
    test(options)
    api_key = app_store_connect_api_key(
      key_id: ENV.fetch("APP_STORE_CONNECT_KEY_ID"),
      issuer_id: ENV.fetch("APP_STORE_CONNECT_ISSUER_ID"),
      key_filepath: ENV.fetch("APP_STORE_CONNECT_KEY_PATH"),
      duration: 1200,
      in_house: false
    )

    build_app(
      project: options[:project] || "../Pinball App 2.xcodeproj",
      scheme: options[:scheme] || "Pinball App 2",
      clean: true,
      export_method: "app-store"
    )

    upload_to_testflight(
      api_key: api_key,
      skip_waiting_for_build_processing: true
    )
  end

  desc "Build and submit to App Store Connect"
  lane :release do |options|
    ensure_asc_env
    test(options)
    api_key = app_store_connect_api_key(
      key_id: ENV.fetch("APP_STORE_CONNECT_KEY_ID"),
      issuer_id: ENV.fetch("APP_STORE_CONNECT_ISSUER_ID"),
      key_filepath: ENV.fetch("APP_STORE_CONNECT_KEY_PATH"),
      duration: 1200,
      in_house: false
    )

    build_app(
      project: options[:project] || "../Pinball App 2.xcodeproj",
      scheme: options[:scheme] || "Pinball App 2",
      clean: true,
      export_method: "app-store"
    )

    submit_for_review = options[:submit_for_review].to_s.downcase == "true"
    automatic_release = options[:automatic_release].to_s.downcase == "true"

    upload_to_app_store(
      api_key: api_key,
      force: true,
      skip_screenshots: true,
      skip_metadata: true,
      submit_for_review: submit_for_review,
      automatic_release: automatic_release
    )
  end
end
